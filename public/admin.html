<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body class="bg-gray-100 font-sans flex flex-col items-center justify-start min-h-screen p-4 pt-12">

    <!-- Login Form -->
    <div id="login-form" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Admin Login</h2>
        <form id="loginForm" class="space-y-4">
            <input type="hidden" id="username" name="username" value="admin" autocomplete="username" readonly
                class="sr-only" />
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                <div class="relative">
                    <input type="password" id="password" name="password" required
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        autocomplete="current-password">
                    <button type="button" class="absolute inset-y-0 right-2 flex items-center text-gray-500"
                        onclick="togglePassword('password', this)">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                </div>
            </div>
            <button type="submit"
                class="w-full bg-blue-600 text-white py-2 rounded-md font-semibold hover:bg-blue-700 transition-colors">Log
                In</button>
            <div id="login-message" class="text-center text-red-500 mt-2 hidden"></div>
        </form>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden w-full max-w-2xl bg-white p-6 rounded-lg shadow-xl space-y-6">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-4">Admin Dashboard</h1>

        <div class="border-b mb-6">
            <h2 id="form-title" class="text-xl font-semibold mb-4">Add New Game</h2>
            <form id="gameForm" class="space-y-4">
                <fieldset class="border border-gray-300 p-4 rounded-md">
                    <legend class="text-lg font-semibold">Game Information</legend>

                    <input type="hidden" id="gameId" name="id">

                    <label for="gameName" class="block font-medium">Game Name:</label>
                    <input type="text" id="gameName" name="name" placeholder="Game Name" required
                        class="w-full mb-2 border rounded-md px-3 py-2">

                    <label for="gameBonus" class="block font-medium">Sign Up Bonus:</label>
                    <input type="text" id="gameBonus" name="bonus" placeholder="e.g., 51" required
                        class="w-full mb-2 border rounded-md px-3 py-2">

                    <label for="gameWithdraw" class="block font-medium">Minimum Withdraw Amount:</label>
                    <input type="text" id="gameWithdraw" name="withdraw" placeholder="e.g., 100" required
                        class="w-full mb-2 border rounded-md px-3 py-2">

                    <label for="gameImageUrl" class="block font-medium">Image URL:</label>
                    <input type="text" id="gameImageUrl" name="imageUrl" placeholder="e.g., https://..." required
                        class="w-full mb-2 border rounded-md px-3 py-2">

                    <label for="gameDownloadUrl" class="block font-medium">Download URL:</label>
                    <input type="url" id="gameDownloadUrl" name="downloadUrl" placeholder="e.g., https://..." required
                        class="w-full mb-2 border rounded-md px-3 py-2">

                    <label for="gameType" class="block font-medium">Select Game Type:</label>
                    <select id="gameType" name="type" required class="w-full border rounded-md mb-4 px-3 py-2">
                        <option value="new">New Game</option>
                        <option value="other">Other Game</option>
                    </select>

                    <button type="submit" id="submitBtn"
                        class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition-colors mb-2">
                        Add Game
                    </button>

                    <button type="button" id="cancelBtn"
                        class="w-full bg-gray-400 text-white py-2 rounded-md hover:bg-gray-500 transition-colors hidden">
                        Cancel Edit
                    </button>
                </fieldset>
            </form>
        </div>

        <div>
            <h2 class="text-xl font-semibold mb-4">Current Games</h2>
            <div id="gamesList" class="space-y-4"></div>
        </div>

        <a href="/" class="block mt-6 text-center text-blue-600 hover:underline">Go to Home Page</a>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex justify-center">
        <div style="height: 200px; overflow-y: auto;" class="bg-white p-6 rounded-md shadow-lg w-full max-w-sm mt-12">
            <h3 class="text-lg font-bold mb-4">Enter Admin Password</h3>
            <div class="relative mb-4">
                <input type="password" id="modalPassword" class="w-full px-3 py-2 border rounded-md"
                    placeholder="Admin password">
                <button type="button" class="absolute inset-y-0 right-2 flex items-center text-gray-500"
                    onclick="togglePassword('modalPassword', this)">
                    <i class="fa-solid fa-eye"></i>
                </button>
            </div>
            <div class="flex justify-end space-x-2">
                <button id="cancelPasswordBtn" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
                <button id="submitPasswordBtn"
                    class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex justify-center">
        <div style="height: 200px; overflow-y: auto;" class="bg-white p-6 rounded-md shadow-lg w-full max-w-sm mt-12">
            <p class="mb-4">Are you sure you want to delete this game?</p>
            <div class="flex justify-center space-x-4">
                <button id="cancelDeleteBtn" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
                <button id="confirmDeleteBtn"
                    class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <script>
        const loginForm = document.getElementById('loginForm');
        const adminPanel = document.getElementById('admin-panel');
        const loginMessage = document.getElementById('login-message');
        const gameForm = document.getElementById('gameForm');
        const gamesList = document.getElementById('gamesList');
        const gameIdInput = document.getElementById('gameId');
        const formTitle = document.getElementById('form-title');
        const submitBtn = document.getElementById('submitBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        const passwordModal = document.getElementById('passwordModal');
        const modalPassword = document.getElementById('modalPassword');
        const submitPasswordBtn = document.getElementById('submitPasswordBtn');
        const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');

        const confirmModal = document.getElementById('confirmModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

        let allGames = [];
        let currentDeleteId = null;
        let passwordCallback = null;

        const togglePassword = (inputId, btn) => {
            const input = document.getElementById(inputId);
            const icon = btn.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        };

        const getPassword = () => {
            return new Promise((resolve) => {
                passwordCallback = resolve;
                passwordModal.classList.remove('hidden');
                modalPassword.value = '';
                modalPassword.focus();
            });
        };

        submitPasswordBtn.addEventListener('click', () => {
            passwordModal.classList.add('hidden');
            passwordCallback(modalPassword.value);
        });

        cancelPasswordBtn.addEventListener('click', () => {
            passwordModal.classList.add('hidden');
            passwordCallback(null);
        });

        const fetchGames = async () => {
            try {
                const response = await fetch('/api/games');
                if (!response.ok) throw new Error('Failed to fetch games');
                allGames = await response.json();
                renderGames();
            } catch (error) {
                console.error("Error fetching games:", error);
                gamesList.innerHTML = '<div class="text-center text-gray-500">Error loading games.</div>';
            }
        };

        const renderGames = () => {
            gamesList.innerHTML = '';
            if (allGames.length === 0) {
                gamesList.innerHTML = '<div class="text-center text-gray-500">No games found.</div>';
                return;
            }
            allGames.forEach(game => {
                const gameDiv = document.createElement('div');
                gameDiv.className = 'flex items-center justify-between bg-gray-50 p-4 rounded-md border';
                gameDiv.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <img src="${game.imageUrl}" alt="${game.name} Logo" class="w-10 h-10 rounded-xl" />
                        <div>
                            <h4 class="font-bold">${game.name}</h4>
                            <p class="text-xs text-gray-500">Type: ${game.type}</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button class="edit-btn bg-blue-500 text-white text-xs px-3 py-1 rounded-md">Edit</button>
                        <button class="delete-btn bg-red-500 text-white text-xs px-3 py-1 rounded-md">Delete</button>
                    </div>
                `;
                gameDiv.querySelector('.edit-btn').addEventListener('click', () => handleEdit(game));
                gameDiv.querySelector('.delete-btn').addEventListener('click', () => {
                    currentDeleteId = game.id;
                    confirmModal.classList.remove('hidden');
                });
                gamesList.appendChild(gameDiv);
            });
        };

        const handleEdit = (game) => {
            gameIdInput.value = game.id;
            document.getElementById('gameName').value = game.name;
            document.getElementById('gameBonus').value = game.bonus;
            document.getElementById('gameWithdraw').value = game.withdraw;
            document.getElementById('gameImageUrl').value = game.imageUrl;
            document.getElementById('gameDownloadUrl').value = game.downloadUrl;
            document.getElementById('gameType').value = game.type;
            formTitle.textContent = 'Edit Game';
            submitBtn.textContent = 'Save Changes';
            cancelBtn.classList.remove('hidden');
        };

        confirmDeleteBtn.addEventListener('click', async () => {
            confirmModal.classList.add('hidden');
            const password = await getPassword();
            if (!password) return;

            try {
                const response = await fetch(`/api/admin/games/${currentDeleteId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                if (!response.ok) throw new Error('Failed to delete game');
                fetchGames();
            } catch (error) {
                alert('Error deleting game.');
                console.error("Error deleting game:", error);
            }
        });

        cancelDeleteBtn.addEventListener('click', () => {
            confirmModal.classList.add('hidden');
            currentDeleteId = null;
        });

        gameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = gameIdInput.value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/admin/games/${id}` : '/api/admin/games';
            const password = await getPassword();
            if (!password) return;

            const gameData = {
                password,
                name: document.getElementById('gameName').value,
                bonus: document.getElementById('gameBonus').value,
                withdraw: document.getElementById('gameWithdraw').value,
                imageUrl: document.getElementById('gameImageUrl').value,
                downloadUrl: document.getElementById('gameDownloadUrl').value,
                type: document.getElementById('gameType').value,
            };

            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(gameData)
                });
                if (!response.ok) throw new Error('Failed to save game');

                gameForm.reset();
                gameIdInput.value = '';
                formTitle.textContent = 'Add New Game';
                submitBtn.textContent = 'Add Game';
                cancelBtn.classList.add('hidden');

                fetchGames();
            } catch (error) {
                alert('Error saving game.');
                console.error("Error saving game:", error);
            }
        });

        cancelBtn.addEventListener('click', () => {
            gameForm.reset();
            gameIdInput.value = '';
            formTitle.textContent = 'Add New Game';
            submitBtn.textContent = 'Add Game';
            cancelBtn.classList.add('hidden');
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                if (response.ok) {
                    document.getElementById('login-form').classList.add('hidden');
                    adminPanel.classList.remove('hidden');
                    fetchGames();
                } else {
                    loginMessage.textContent = 'Invalid password.';
                    loginMessage.classList.remove('hidden');
                }
            } catch (error) {
                loginMessage.textContent = 'Server error. Please try again.';
                loginMessage.classList.remove('hidden');
                console.error("Login error:", error);
            }
        });
    </script>
</body>

</html>
